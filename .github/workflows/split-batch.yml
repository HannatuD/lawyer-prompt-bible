name: Split Claude batch
on:
  push:
    paths: ['incoming/claude_batch.md']

jobs:
  split:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Run splitter
      run: |
        python - <<'PY'
        import pathlib, re
        src = pathlib.Path('incoming/claude_batch.md')
        if not src.exists():
            print('No batch file â€“ skip')
            exit(0)
        txt = src.read_text()
        parts = [p.strip() for p in txt.split('--------') if p.strip()]
        for part in parts:
            pid = re.search(r'prompt_id:\s*([^\s]+)', part).group(1)
            _, sub, task, _ = pid.split('-', 3)   # tech-saas-drafting-002
            folder = pathlib.Path(f'prompts/corporate-commercial/{sub}/{task}/{pid}')
            folder.mkdir(parents=True, exist_ok=True)
            (folder / 'base-prompt.md').write_text(part + '\n')
        print(f'Split {len(parts)} files')
        PY
    - name: Commit results
      run: |
        git config user.name  "batch-bot"
        git config user.email "batch@example.com"
        git add prompts
        git rm incoming/claude_batch.md
        git commit -m "feat(prompts): auto-split Claude tech batch" || echo "Nothing to commit"
        git push
